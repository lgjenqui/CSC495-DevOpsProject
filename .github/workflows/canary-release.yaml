name: canary-release

on:
  pull_request:
    branches:
      - 'release**'
    types:
      - closed
  # TODO: DELETE LATER- JUST FOR TESTING PURPOSES
  push:
    branches:
      - feature-*

jobs:
  build:
    name: Build Release Docker Image
    # if: github.event.pull_request.merged == true
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build Docker image
        working-directory: canary
        run: docker buildx create --use && docker buildx build -t setup-k8s .
        
      - name: Run Docker container
        run: |
          docker run \
            -v $HOME/.ssh:/root/.ssh \
            setup-k8s \
            sh -c "ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root cluster.yml"
  
  canary-deploy:
    name: Begin Canary Deployment
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
