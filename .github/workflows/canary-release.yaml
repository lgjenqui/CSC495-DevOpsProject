name: canary-release
on:
  pull_request:
    branches:
      - 'release**'
    types:
      - closed
#TODO: DELETE LATER- JUST FOR TESTING PURPOSES
  push:
    branches:
      - feature-*

jobs:
  build:
    name: Build Release Docker Image
   # if: github.event.pull_request.merged == true
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Build Docker image
        working-directory: canary
        run: docker build -t setup-k8s .

      - name: Run Docker container
        run: |
          docker run -it \
            -v $HOME/.ssh:/root/.ssh \
            your_image_name \
            sh -c "ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root cluster.yml"
  
  canary-deploy:
    name: Begin Canary Deployment
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
